safekeep(1)
==========

NAME
----
safekeep - Client/server backup script

SYNOPSIS
--------
'safekeep' [--server] [-q] [-v] [-c file] [-e <email>] [-s <smtp>] <clientid>*

'safekeep' --keys [-q] [-v] [-c file] [--status] [--print] [--deploy] <clientid>*

'safekeep' --client

'safekeep' -h | -V

DESCRIPTION
-----------
SafeKeep is a client/server backup script which enhances the
power of rdiff-backup with simple configuration and use.

SafeKeep can work in server mode, client mode or SSH key management mode.

In server mode, SafeKeep parses a set of configurations files which
defines a set of backup clients. For each backup client, SafeKeep
connects to the client host over SSH (using a public key authentification
system previously set up using `safekeep -keys --deploy`), and launches
`safekeep --client` onto the client host. The client does the real backup
and sends the data over SSH to the SafeKeep server which stores it in
the specified location.

In client mode, SafeKeep does a few setup steps, depending on the
client configuration (database dump, LVM device snapshot), then backups
the client data using `rdiff-backup`, and then cleanups the state
(removes the database dumps, deactivates the LVM snapshots)

Note that the client mode of SafeKeep should never be invoked manually,
this mode is meant to be used only by the server mode of SafeKeep.

The SSH key management mode is a helper mode for deploying or verifying
the setup of the SSH authentification keys.

In both server and keys management mode, you can restrict the operation
to a specific set of clients by listing the desired client IDs as
arguments. If no client ID is given, SafeKeep will operate over all known
clients.

Each mode accepts a few options as described below.

OPERATION MODE
--------------
--server::
	Selects the server mode (default)

--client::
	Selects the client mode. This should never be invoked manually, the
	clients are started automatically by the server on the client machines
	using SSH.

--keys::
	Selects the SSH key management mode


GENERAL OPTIONS
---------------
-h, --help::
	Selects the help mode, in which safekeep prints out the
	online help and exits.

-V, --version::
	Selects the version mode, in which safekeep prints out the
	version number and exits.

-q, --quiet::
	Decreases the verbosity level. Can be specified more than
	once.

-v, --verbose::
	Increases the verbosity level. Can be specified more than
	once.

SERVER OPTIONS
--------------
-c, --conf=FILE|DIR::
	Specifies the configuration file location.
	This can be a single file (for a single client configuration)
	or a directory containing several configuration files (one per
	backup client). Can be specified multiple times.
        If not specified at all, SafeKeep will default to searching 
        `/etc/safekeep.d/` for configuration files. 
        Simply using this default is the recommended usage. 

-e, --email=EMAIL::
	In addition to writing the session logs
	on the standard output, this parameter let the user specify
	the mail address where the logs are to be send. Can be specified
	more than once to send reports to multiple addresses.

-s, --smtp=SMTP::
	Specifies the SMTP server used for sending mails when `-e` is used. 
	Defaults to using `/usr/sbin/sendmail`.

KEYS OPTIONS
------------
--status::
	Display the key status for the clients. It is implied if no other
        option is specified. In effect this option prints the steps that
        will be taken when the keys are deployed to the client.

--print::
	Display the authorization keys for the clients. This is useful in
        case you want to manually copy it into the client's 
        `~/.ssh/authorized_keys` file. This option is seldom useful.

--deploy::
	Deploy the authorization keys on the clients.

CONFIGURATION
-------------

Normally the configuration files are placed in the `/etc/safekeep.d/` directory
from where they will get picked up automatically by SafeKeep. Each backup
client is described by a configuration file in XML format. The minimum 
configuration file is:
------------------------------------------------------------------------
<backup>
  <host name="my_workstation" />
</backup>
------------------------------------------------------------------------
This will simply backup all relevant files (excluding temporary files,
caches, etc) from the client with the address `my_workstation`.

A more realistic example:
------------------------------------------------------------------------
<backup>
  <host name="my_workstation" />
  <repo retention="10D" />
  <setup>
      <dump type="postgres" user="postgres" file="/var/lib/pgsql/backups/all_dbs" />
      <snapshot device="/dev/mapper/VolGroup00-LogVol00" size="500M" />
  </setup>

  <data>
    <exclude regexp=".*\.ogg"/>
    <exclude regexp=".*\.mp3"/>

    <include path="/etc"/>

    <exclude glob="/home/*/tmp"/>
    <include path="/home"/>

    <include path="/root"/>

    <include path="/srv"/>

    <exclude path="/var/cache"/>
    <exclude path="/var/lock"/>
    <exclude path="/var/run"/>
    <exclude path="/var/tmp"/>
    <include path="/var/named/chroot/etc"/>
    <include path="/var/named/chroot/var/named"/>
    <exclude path="/var/named/chroot"/>
    <include path="/var"/>

    <exclude path="/"/>
  </data>
</backup>
------------------------------------------------------------------------
In this case, SafeKeep will dump all databases managed by PostgreSQL,
snapshot the disk via LVM, and proceed to backup `/etc`, `/home`,
`/root`, `/srv`, `/var`, while excluding some unneeded files and
directories. Older data will be retained for 10 days.

For full reference documentation of the configuration format, see
safekeep.conf(5).

CLIENT IDS
----------
Normally the client IDs are generated automatically from the configuration
filenames without the extension. E.g. if a configuration file is named
`my_workstation.conf`, the client ID becomes `my_workstation`. For more
information on this topic, see safekeep.conf(5).

SEE ALSO
--------
rdiff-backup(1), safekeep.conf(5)

AUTHOR
------
Written by Dimi Paun <dimi@lattica.com> and Stelian Pop <stelian@lattica.com>.

