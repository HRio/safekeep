#!/usr/bin/python

import getopt, os, os.path, shutil, socket, sys
import commands, random, time, tempfile, traceback
from commands import mkarg

ssh_id_file_keys = None
sign_packages = 0
perform_snaphots = False

class TestFailure(Exception):
    pass

def mkssh(cmd='ssh'):
    args = [cmd]
    ssh_id_file = ssh_id_file_keys[0]
    if ssh_id_file:
        args.append('-i')
        args.append(mkarg(ssh_id_file))
    return ' '.join(args)

def rpipe(cmd, user, host, desc, cmd2, user2, host2):
    if host:
        cmd = '%s %s@%s %s' % (mkssh(), user, host, mkarg(cmd))
    if host2:
        cmd2 = '%s %s@%s %s' % (mkssh(), user2, host2, mkarg(cmd2))
    print cmd, '|', cmd2
    pout = os.popen(cmd, 'r')
    pin = os.popen(cmd2, 'w')
    for line in pout:
        pin.write(line)
    st1 = pout.close()
    st2 = pin.close()
    if desc and st1:
        raise TestFailure('Failed to %s on host %s' % (desc, host))
    if desc and st2:
        raise TestFailure('Failed to %s on host %s' % (desc, host2))
    if st1: return st1
    return st2

def rcmd(cmd, user, host, desc=None):
    if host:
        cmd = '%s %s@%s %s' % (mkssh(), user, host, mkarg(cmd))
    print cmd
    st = os.system(cmd)
    if desc and st:
        raise TestFailure('Failed to %s on host %s' % (desc, host))
    return st

def rcmdin(cmd, content, user, host, desc=None):
    if host:
        cmd = '%s %s@%s %s' % (mkssh(), user, host, mkarg(cmd))
    print cmd
    pipe = os.popen(cmd, 'w')
    pipe.write(content)
    st = pipe.close()
    if st and desc:
        raise TestFailure('Failed to %s for %s@%s' % (desc, user, host))
    return st

def rcmdout(cmd, user, host, desc=None):
    if host:
        cmd = '%s %s@%s %s' % (mkssh(), user, host, mkarg(cmd))
    print cmd
    out = os.popen(cmd, 'r')
    try:
        return out.read()
    finally:
        st = out.close()
        if desc and st:
            raise TestFailure('Failed to %s on host %s' % (desc, host))
        if st:
            return None

def readfile(file, user=None, host=None):
    if host:
        cmd = 'cat %s' % file
        return rcmdout(cmd, user, host, 'read file %s' % file)
    else:
        fin = open(file)
        try:
            return fin.read()
        finally:
            fin.close()

def writefile(file, content, perm=None, mode='w', user=None, host=None):
    """
    Creates a file with the given name, content, and mode.
    The file may be passed in by name, as an open file object, 
    or as  file descriptor. If passed as a file object or file descriptor,
    it will be closed after the content will be written to it.
    """
    if host:
        if mode.startswith('a'):
            cmd = 'cat >> %s' % mkarg(file)
        else:
            cmd = 'cat > %s' % mkarg(file)
        rcmdin(cmd, content, user, host, 'write file %s' % file)
        if perm != None:
            cmd = 'chmod %s %s' % (perm, file)
            rcmd(cmd, user, host, 'set file permissions for ' + file)
    else:
        fout = open(file, mode)
        try:
            fout.write(content)
        finally:
            fout.close()

        if perm != None and isinstance(file, types.StringTypes): 
            os.chmod(file, perm)

def augmentfile(file, user=None, host=None):
    content = ""
    for i in range(random.randint(5, 20)):
        content = '%sSome random nr: %s\n' % (content, random.random())
    writefile(file, content, mode='a', user=user, host=host)

def localTest(tmproot):
    params = {'tmproot': tmproot}
    os.mkdir(os.path.join(tmproot, 'client'))
    os.mkdir(os.path.join(tmproot, 'client', 'data'))
    os.mkdir(os.path.join(tmproot, 'client', 'home'))
    os.mkdir(os.path.join(tmproot, 'client', 'misc'))
    os.mkdir(os.path.join(tmproot, 'server'))
    CONFIG = """
       <backup id="%(tmproot)s">
          <repo path="%(tmproot)s/server" />
          <data>
             <exclude glob="**/*.nobackup" />
             <include path="%(tmproot)s/client" />
          </data>
        </backup>
    """
    writefile(os.path.join(tmproot, 'test.cfg'), CONFIG % params)
    for i in range(2):
        FILES = (
            'data/fileA.out', 
            'data/fileB.nobackup', 
            'data/fileC.out', 
            'home/unit.out', 
            'home/office.out', 
            'home/street.out', 
            'misc/file.nobackup', 
        )
        for file in FILES:
            augmentfile(os.path.join(tmproot, 'client', file))
        cmd = "cd %(tmproot)s/client; find -type f -a \! -name '*.nobackup' | sort | xargs md5sum > %(tmproot)s/md5sums.client"
        if os.system(cmd % params):
            raise TestFailure("Can't compute the source MD5 sums")
        cmd = "LaBackup --cfg '%(tmproot)s/test.cfg'"
        if os.system(cmd % params):
            raise TestFailure("Can't backup files")
        os.mkdir(os.path.join(tmproot, 'restore'))
        cmd = "rdiff-backup -r now %(tmproot)s/server %(tmproot)s/restore"
        if os.system(cmd % params):
            raise TestFailure("Can't restore files")
        cmd = "cd %(tmproot)s/restore%(tmproot)s/client; find -type f | sort | xargs md5sum > %(tmproot)s/md5sums.restore"
        if os.system(cmd % params):
            raise TestFailure("Can't compute the source MD5 sums")
        cmd = "diff -u %(tmproot)s/md5sums.client %(tmproot)s/md5sums.restore"
        if os.system(cmd % params):
            raise TestFailure("The MD5 sums differ")
        shutil.rmtree(os.path.join(tmproot, 'restore'))
        time.sleep(1) 

def takeOver(host, role):
    cmd = 'ssh -o PasswordAuthentication=no root@%s true' % (host)
    if os.system(cmd): 
        print 'The box %s does not appear to have been initialized' % (host)
        print 'for functioning as %s in a LaBackup remote test.' % (role)
        print 'If you want to use it in such a role, please enter the root'
        print 'password for the box so that the test can take over it.'
        print 'WARNING: the test is potentially dangereous, all data on'
        print '         the box may be lost! Please make SURE this is'
        print '         the box you REALLY intend to use for the test.'
        print 'To cancel the test, type Ctrl-C'
        # add the key blindly to make sure we have it, and we are asked the passwd only once
        cmd = 'umask 077; test -d .ssh || mkdir .ssh; cat >> .ssh/authorized_keys'
        rcmdin(cmd, ssh_id_file_keys[1], 'root', host)

    cmd = 'rpm --import http://lattica.com/keys/RPM-GPG-KEY-lattica-devel'
    rcmd(cmd, 'root', host, 'install Lattica Devel Key')
    lattica_repo = """
        [lattica-development]
        name=Lattica - Development Tree  for Fedora Core $releasever $basearch
        baseurl=http://lattica.com/repos/lattica/yum/fedora/$releasever/devel/$basearch
        gpgkey=http://lattica.com/keys/RPM-GPG-KEY-lattica-devel
        enabled=1
        gpgcheck=%s
    """ % (sign_packages)
    lattica_repo = '\n'.join([line.strip() for line in lattica_repo.splitlines()])
    cmd = 'echo %s > /etc/yum.repos.d/lattica.repo' % (mkarg(lattica_repo).strip())
    rcmd(cmd, 'root', host, 'install Lattica Repo')
    cmd = 'if rpm -q LaBackup; then rm -rf /var/cache/yum/lattica-development/; yum update -y LaBackup; else yum install -y LaBackup; fi'
    rcmd(cmd, 'root', host, 'install LaBackup')

def createKey(user, host, keyname, comment):
    key = '/home/%s/.ssh/%s' % (user, keyname)
    cmd = 'test -f %s || ssh-keygen -q -b 1024 -t dsa -N \'\' -C \'%s\' -f %s' % (key, comment, key)
    rcmd(cmd, user, host, 'create %s on server' % keyname)
    return key

def packageAndUpload(pkgroot, keyname, repodir, user, host):
    rpmmacros = """
%%packager          LaBackup Tester Package Builder
%%_topdir           %s
%%_debug_package    %%{nil}

%%_signature         gpg
""" % (pkgroot)
    writefile(os.path.join(pkgroot, '.rpmmacros'), rpmmacros)

    # and the directories needed by rpmbuild
    for dir in ('BUILD', 'RPMS/noarch', 'SOURCES', 'SPECS', 'SRPMS'):
        os.makedirs(os.path.join(pkgroot, dir))

    cmd = 'make tar'
    if os.system(cmd):
        raise TestFailure('Failed to build the tar snapshot')
    files = os.listdir('.')
    mytar = None
    for file in files:
        if file.startswith('LaBackup-') and file.endswith('.tar.gz'):
            if file > mytar:
                mytar = file # last one wins
    if not mytar:
        raise TestFailure('Failed to determine the tar name')

    cmd = 'HOME=%s rpmbuild -ta %s' % (pkgroot, mytar)
    print cmd
    if os.system(cmd):
        raise TestFailure('Failed to build the .rpm')

    cmd = 'rm %s' % (mytar)
    print cmd
    if os.system(cmd):
        raise TestFailure('Failed to nuke the tar')

    basename = mytar[0:-len('.tar.gz')]
    binrpm = os.path.join(pkgroot, 'RPMS/noarch', basename + '-1.noarch.rpm')
    if not os.path.isfile(binrpm):
        raise TestFailure('Failed to find binary rpm: %s' % binrpm)

    if sign_packages:   
        cmd = 'rpm --define %s --addsign %s' % (mkarg('_gpg_name ' + keyname), mkarg(binrpm))
        print cmd
        if os.system(cmd):
            raise TestFailure('Failed to sign rpms')

    cmd = '%s %s %s@%s:%s' % (mkssh('scp'), mkarg(binrpm), user, host, repodir)
    print cmd
    if os.system(cmd):
        raise TestFailure('Failed to copy %s to the repository' % binrpm) 
    
    cmd = 'createrepo %s' % mkarg(repodir)
    rcmd(cmd, user, host, 'update repo metadata') 

def remoteTest(tmproot, client, server):
    # build, sign and upload the .rpm
    repodir = '/var/www/repos/lattica/yum/fedora/5/devel/i386'
    packageAndUpload(tmproot, 'Lattica, Inc. (Devel Key) <devel@lattica.com>', repodir, 'root', 'achilles')

    takeOver(client, 'client')
    takeOver(server, 'server')

    # setup the server
    client_addr = socket.gethostbyname(client)
    if client_addr != client:
        cmd = 'if ! grep -iq %s /etc/hosts; then echo "%s   %s" >> /etc/hosts; fi' % (client, client_addr, client)
        rcmd(cmd, 'root', server, 'install the client name in /etc/hosts')

    cmd = 'useradd backup-op || true'
    rcmd(cmd, 'root', server, 'create backup-op user')
    cmd = 'cd ~backup-op; umask 077; test -d .ssh || mkdir .ssh; ' + \
          'cp /root/.ssh/authorized_keys .ssh/authorized_keys; ' + \
          'chown -R backup-op.backup-op .ssh'
    rcmd(cmd, 'root', server, 'install key for backup-op user')
    key_id   = createKey('backup-op', server, 'id_dsa', 'LaBackup server ID')
    key_ctrl = createKey('backup-op', server, 'LaBackup-server-ctrl-key', 'LaBackup server control key')
    key_data = createKey('backup-op', server, 'id-LaBackup-data-key', 'LaBackup server data key')

    cmd = 'if ! rpm -q postgresql-server; then p=postgresql-server; fi; ' +
          'if ! rpm -q mysql-server; then p="$p mysql-server"; fi; ' +
          'if [ "x$p" != "x" ]; then yum install $p; fi' +
          'if service postgresql status | grep -v running; then service postgres start; fi' +
          'if service mysqld status | grep -v running; then service mysqld start; fi'
    rcmd(cmd, 'root', server, 'ensure RDBMSes are installed and running')
   
    known_hosts = os.path.join(os.environ['HOME'], '.ssh', 'known_hosts')
    cmd = 'if test -f %s; then grep -i %s %s; fi' % (known_hosts, client, known_hosts)
    fingerprint = rcmdout(cmd, None, None, 'read the client fingerprint')
    if fingerprint:
        cmd = 'if grep -qi LaBackup .ssh/known_hosts; then cat > /dev/null; else cat >> .ssh/known_hosts; fi'
        rcmdin(cmd, fingerprint, 'backup-op', server, 'deploy client fingerprint on server')

    snap_cfg = ''
    if perform_snaphots:
        snap_cfg = '<snapshot device="/dev/mapper/VolGroup00-LogVol00" size="50M"/>'
    cfg = """
        <backup id="test-client">
          <host name="%s" user="root" key-data="%s" />
          <repo path="/home/backup-op/client/data" retention="10m"/>
          %s
          <data>
             <exclude glob="**/*.nobackup" />
             <exclude path="/etc/cups/certs" />
             <include path="/etc" />
             <include path="/srv" />
          </data>
        </backup>
        """ % (client, key_data, snap_cfg)

    writefile('/etc/LaBackup.d/test-client.cfg', cfg, '664', 'w', 'root', server)
    cmd = 'rm -rf client; mkdir -p client/data'
    rcmd(cmd, 'backup-op', server, 'create data repo') 

    # setup the client
    cmd = 'umask 077; test -d .ssh || mkdir .ssh; if test -f .ssh/authorized_keys; then cat .ssh/authorized_keys; fi'
    clkeys_txt = rcmdout(cmd, 'root', client, 'fetch client keys')
    key_id_enc = readfile('.ssh/id_dsa.pub', 'backup-op', server)
    if key_id_enc not in clkeys_txt.splitlines():
        writefile('.ssh/authorized_keys', key_id_enc, None, 'a', 'root', client)

    cmd = 'LaBackup --keys --deploy'
    rcmd(cmd, 'backup-op', server, 'deploy keys to client')

    # run the test
    for i in range(2):
        cmd = 'rm -f md5sum.*'
        rcmd(cmd, 'backup-op', server, 'cleanup MD5 sums')
        FILES = (
            '/etc/a-simple-file', 
            '/etc/another-file.nobackup', 
            '/srv/LaBackup-test1.log', 
            '/srv/LaBackup-test2.nobackup',
        )
        for file in FILES:
            augmentfile(file, 'root', client)
        cmd1 = "cd /; (find /etc -type f; find /srv -type f) | grep -v '\.nobackup$' | grep -v '^/etc/cups/certs/' | sort | sed s/.// | xargs md5sum"
        cmd2 = "cat > /home/backup-op/md5sum.client"
        rpipe(cmd1, 'root', client, 'do MD5 sums on client', cmd2, 'backup-op', server)
        cmd = 'LaBackup'
        rcmd(cmd, 'backup-op', server, 'backup data')
        cmd = 'cd /home/backup-op/client/data; find -type f | grep -v rdiff-backup-data/ | sort | sed s/..// | xargs md5sum > /home/backup-op/md5sum.server'
        rcmd(cmd, 'backup-op', server, 'do MD5 sums on server')
        cmd = 'diff -q /home/backup-op/md5sum.client /home/backup-op/md5sum.server'
        rcmd(cmd, 'backup-op', server, 'compare MD5 sums')
        
        # TODO: list available backups
        # TODO: compare against retention policy, fail if different
        cmd = 'if lvscan | grep _snap_; then false; fi'
        rcmd(cmd, 'root', client, 'test that no snapshots are left behind')
        cmd = 'if grep 'LaBackup-.*-rbind' /proc/mounts; then false; fi'
        rcmd(cmd, 'root', client, 'test that no --rbind mounts are left behind')
        # TODO: check iff appropriate DB dumps deleted
        time.sleep(1) 

def guess_ssh_id_file_keys():
    if os.environ.get('SSH_AUTH_SOCK'):
        out = os.popen('ssh-add -L', 'r')
        ids = out.read()
        if out.close() or not ids:
            print >> sys.stderr, 'Failed to get keys from ssh agent'
        else:
            return (None, ids)
    for filename in ('identity', 'id_dsa', 'id_rsa'):
        file = os.path.join(os.environ['HOME'], '.ssh', filename)
        if os.path.isfile(file): 
            return (file, readfile(file))
    return None

def usage():
    print 'usage: %s [options]' % (sys.argv[0])
    print
    print 'options:'
    print '-l,--local            Run the local version of the test (default)'
    print '-r,--remote           Run the client/server version of the test'
    print '-n,--nocleanup        Do not erase the temporary root for the test'
    print '-i,--identity IDFILE  SSH identity file to use (remote test only)'
    print '-c,--client=ADDR      The client address (remote test only)'
    print '-s,--server=ADDR      The server address (remote test only)'
    print '-h,--help             Print this help message and exit'

def main():
    global ssh_id_file_keys
    try:
        opts, args = getopt.getopt(sys.argv[1:], 
                                   'lrni:c:s:', 
                                   ['local', 'remote', 'nocleanup', 'identity', 'client=', 'server='])
    except getopt.GetoptError:
        usage()
        sys.exit(2)

    client = os.environ.get('LABACKUP_TEST_CLIENT')
    server = os.environ.get('LABACKUP_TEST_SERVER')
    nocleanup = False
    mode = 'local'
    for o, a in opts:
        if o in ('-l', '--local'):
            mode = 'local'
        elif o in ('-r', '--remote'):
            mode = 'remote'
        elif o in ('-n', '--nocleanup'):
            nocleanup = True
        elif o in ('-i', '--identity'):
            ssh_id_file_keys = (a, readfile(a))
        elif o in ('-c', '--client'):
            client = a
        elif o in ('-s', '--server'):
            server = a
        elif o in ('-h', '--help'):
            usage()
            sys.exit()

    if not client: client = 'LaBackup-test-client'
    if not server: server = 'LaBackup-test-server'

    exitcode = 0
    tmproot = tempfile.mkdtemp()
    try:
        try:
            if mode == 'remote':
                if not ssh_id_file_keys:
                    ssh_id_file_keys = guess_ssh_id_file_keys()
                assert ssh_id_file_keys, "Can not determine the SSH keys"
                remoteTest(tmproot, client, server)
            else:
                localTest(tmproot)
        except TestFailure, tf:
            print tf
            exitcode = 1
    finally:
        if nocleanup:
            print tmproot
        else:
            shutil.rmtree(tmproot)

    sys.exit(exitcode)

if __name__ == '__main__':
    main()

# vim: et ts=8 sw=4 sts=4
