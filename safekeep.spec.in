%define name    safekeep
%define version TBD
%define release 1
%define homedir %{_localstatedir}/lib/%{name}

Name:           %{name}
Version:        %{version}
Release:        %{release}%{?dist}
Summary:        The SafeKeep backup system

Group:          Applications/System
License:        GPL
URL:            http://safekeep.sourceforge.net
Source0:        http://prdownloads.sourceforge.net/%{name}/%{name}-%{version}.tar.gz
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)

BuildArch:      noarch
BuildRequires:	xmlto, asciidoc > 6.0.3

%description
SafeKeep is a client/server backup system which enhances the
power of rdiff-backup with simple, centralized configuration.

%package common
Summary:        The SafeKeep backup system (common component)
Group:          Applications/System
Requires:       rdiff-backup
Requires:       python >= 2.2

%description common
SafeKeep is a client/server backup system which enhances the
power of rdiff-backup with simple, centralized configuration.

This is the common component of SafeKeep. It is shared in 
between the client/server components.

%package client
Summary:        The SafeKeep backup system (client component)
Group:          Applications/System
Requires:       openssh-server
Requires:       coreutils
Requires:       util-linux
Requires:       safekeep-common = %{PACKAGE_VERSION}

%description client
SafeKeep is a client/server backup system which enhances the
power of rdiff-backup with simple, centralized configuration.

This is the client component of SafeKeep. It should be
installed on all hosts that need to be backed-up.

%package server
Summary:        The SafeKeep backup system (server component)
Group:          Applications/System
Requires(pre):  /usr/sbin/useradd, /usr/bin/chsh
Requires(unpre):/usr/sbin/userdel
Requires:       openssh, openssh-clients
Requires:       safekeep-common = %{PACKAGE_VERSION}

%description server
SafeKeep is a client/server backup system which enhances the
power of rdiff-backup with simple, centralized configuration.

This is the server component of SafeKeep. It should be
installed on the server on which the data will be backed-up to.

%prep
%setup -q

%build
make build

%install
install -d -m 755 "%{buildroot}%{_sysconfdir}/safekeep/backup.d"
install -m 664 safekeep.conf "%{buildroot}%{_sysconfdir}/safekeep/"
install -d -m 755 "%{buildroot}%{_sysconfdir}/cron.daily"
install -m 755 safekeep.cron "%{buildroot}%{_sysconfdir}/cron.daily/safekeep"
install -d -m 755 "%{buildroot}%{_bindir}/"
install -m 755 safekeep "%{buildroot}%{_bindir}/"
install -d -m 755 "%{buildroot}%{_mandir}/man1/"
install -m 444 doc/safekeep.1 "%{buildroot}%{_mandir}/man1/"
install -d -m 755 "%{buildroot}%{_mandir}/man5/"
install -m 444 doc/safekeep.conf.5 "%{buildroot}%{_mandir}/man5/"
install -m 444 doc/safekeep.backup.5 "%{buildroot}%{_mandir}/man5/"
install -d -m 750 "%{buildroot}%{homedir}"
install -d -m 700 "%{buildroot}%{homedir}/.ssh"

%clean
rm -rf "%{buildroot}"

%pre server
%{_sbindir}/useradd -r -d %{homedir} -s /bin/bash -u 186 %{name} 2> /dev/null || :
%{_bindir}/chsh -s /bin/bash %{name} > /dev/null || :

%post server
if test -d /etc/safekeep.d; then
    for file in /etc/safekeep.d/*.conf; do
        if test -f "$file"; then 
            mv "$file" /etc/safekeep/backup.d/`basename "$file" .conf`.backup
        fi
    done
    rmdir /etc/safekeep.d 2> /dev/null || :
fi

%preun server
if [ "$1" = "0" ]; then
    %{_sbindir}/userdel %{name} >> /dev/null 2>&1 || :
fi

%files common
%defattr(-,root,root,-)
%{_bindir}/safekeep
%{_mandir}/man1/safekeep.1*
%{_mandir}/man5/safekeep.conf.5*
%{_mandir}/man5/safekeep.backup.5*
%doc AUTHORS COPYING LICENSE README TODO

%files client
%doc AUTHORS COPYING LICENSE

%files server
%attr(750,%{name},%{name}) %dir %{homedir}
%attr(700,%{name},%{name}) %dir %{homedir}/.ssh
%dir %{_sysconfdir}/safekeep
%dir %{_sysconfdir}/safekeep/backup.d
%config %{_sysconfdir}/safekeep/safekeep.conf
%{_sysconfdir}/cron.daily/safekeep
%doc safekeep-test sample.backup
%doc AUTHORS COPYING LICENSE

%changelog
* Wed May 16 2007 Dimi Paun <dimi@lattica.com> 1.0.0-1
  - Small documentation inprovements.

* Fri Apr 27 2007 Dimi Paun <dimi@lattica.com> 0.9.3-1
  - Use /bin/bash as the shell for the safekeep system account;
  - Invoke rdiff-backup with --force when trimming histroy;
  - A few small logging bugs got fixed;
  - Small documentation tweaks.

* Tue Mar 13 2007 Dimi Paun <dimi@lattica.com> 0.9.2-1
  - Client configuration files have been moved to 
    /etc/safekeep/backup.d, and have the extension '.backup';
  - A new global configuration file has been added in 
    /etc/safekeep/safekeep.conf;
  - A number of command line options have been deprecated;
    (-e/--email, -s/--smtp), and moved to the global configuration.
  - SafeKeep now knows of the user under which the backup will execute,
    making it possible to better deploy keys, avoid the need to invoke
    safekeep(1) via sudo(8), and execute the backup as root if need be;
  - Relative paths now have more intuitive behaviour;
  - Some documentation improvements;
  - Automatic migration of old configuration to the new format;
  - A CRITICAL (e.g. data loss) race has been fixed.

* Mon Feb 12 2007 Dimi Paun <dimi@lattica.com> 0.9.1-1
  - Lots of documentation improvements;
  - Prepare the RPMs for Fedora acceptance (Jef Spaleta);
  - Automatic creation of data store directory;
  - A few bug fixes.

* Thu Feb  1 2007 Dimi Paun <dimi@lattica.com> 0.9.0-1
  - Initial release
