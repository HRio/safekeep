%define name    safekeep
%define version TBD
%define release 1
%define homedir %{_localstatedir}/lib/%{name}

Name:           %{name}
Version:        %{version}
Release:        %{release}%{?dist}
Summary:        The SafeKeep backup system

Group:          Applications/System
License:        GPL
URL:            http://safekeep.sourceforge.net
Source0:        http://prdownloads.sourceforge.net/%{name}/%{name}-%{version}.tar.gz
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)

BuildArch:      noarch
BuildRequires:	xmlto, asciidoc > 6.0.3

%description
SafeKeep is a client/server backup system which enhances the
power of rdiff-backup with simple, centralized configuration.

%package common
Summary:        The SafeKeep backup system (common component)
Group:          Applications/System
Requires:       rdiff-backup
Requires:       python >= 2.2

%description common
SafeKeep is a client/server backup system which enhances the
power of rdiff-backup with simple, centralized configuration.

This is the common component of SafeKeep. It is shared in 
between the client/server components.

%package client
Summary:        The SafeKeep backup system (client component)
Group:          Applications/System
Requires:       openssh-server
Requires:       coreutils
Requires:       util-linux
Requires:       safekeep-common = %{PACKAGE_VERSION}

%description client
SafeKeep is a client/server backup system which enhances the
power of rdiff-backup with simple, centralized configuration.

This is the client component of SafeKeep. It should be
installed on all hosts that need to be backed-up.

%package server
Summary:        The SafeKeep backup system (server component)
Group:          Applications/System
Requires(pre):  /usr/sbin/useradd
Requires(unpre):/usr/sbin/userdel
Requires:       openssh, openssh-clients
Requires:       safekeep-common = %{PACKAGE_VERSION}

%description server
SafeKeep is a client/server backup system which enhances the
power of rdiff-backup with simple, centralized configuration.

This is the server component of SafeKeep. It should be
installed on the server on which the data will be backed-up to.

%prep
%setup -q

%build
make build

%install
install -d -m 755 "%{buildroot}%{_sysconfdir}/safekeep.d"
install -d -m 755 "%{buildroot}%{_sysconfdir}/cron.daily"
install -m 755 safekeep.cron "%{buildroot}%{_sysconfdir}/cron.daily/safekeep"
install -d -m 755 "%{buildroot}%{_bindir}/"
install -m 755 safekeep "%{buildroot}%{_bindir}/"
install -d -m 755 "%{buildroot}%{_mandir}/man1/"
install -m 755 doc/safekeep.1 "%{buildroot}%{_mandir}/man1/"
install -d -m 755 "%{buildroot}%{_mandir}/man5/"
install -m 755 doc/safekeep.conf.5 "%{buildroot}%{_mandir}/man5/"
install -d -m 750 "%{buildroot}%{homedir}"
install -d -m 700 "%{buildroot}%{homedir}/.ssh"

%clean
rm -rf "%{buildroot}"

%pre server
%{_sbindir}/useradd -r -d %{homedir} -s /sbin/nologin -u 186 %{name} 2> /dev/null || :

%preun server
if [ "$1" = "0" ]; then
    %{_sbindir}/userdel %{name} >> /dev/null 2>&1 || :
fi

%files common
%defattr(-,root,root,-)
%{_bindir}/safekeep
%{_mandir}/man1/safekeep.1*
%{_mandir}/man5/safekeep.conf.5*
%doc AUTHORS COPYING LICENSE README TODO

%files client
%doc AUTHORS COPYING LICENSE

%files server
%attr(750,%{name},%{name}) %dir %{homedir}
%attr(700,%{name},%{name}) %dir %{homedir}/.ssh
%dir %{_sysconfdir}/safekeep.d
%config %{_sysconfdir}/cron.daily/safekeep
%doc safekeep-test sample.conf
%doc AUTHORS COPYING LICENSE

%changelog
* Sun Feb 11 2007 Jef Spaleta <jspaleta@gmail.com> 0.9.0-1
- Initial build meant for Fedora package submission
