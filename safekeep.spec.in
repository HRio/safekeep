%define name    safekeep
%define version TBD
%define release 1
%define homedir %{_localstatedir}/lib/%{name}

Name:           %{name}
Version:        %{version}
Release:        %{release}%{?dist}
Summary:        The SafeKeep backup system
Vendor:         Lattica, Inc.

Group:          Applications/System
License:        GPL
URL:            http://safekeep.sourceforge.net
Source0:        %{name}-%{version}.tar.gz
BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
Prefix:         %{_prefix}

BuildArch:      noarch
BuildRequires:	xmlto, asciidoc > 6.0.3

%description
SafeKeep is a client/server backup system which enhances the
power of rdiff-backup with simple configuration and use.

%package common
Summary:        The SafeKeep backup system (common component)
Group:          Applications/System
Obsoletes:      safekeep
Requires:       rdiff-backup
Requires(pre):  python >= 2.3

%description common
The common component of the SafeKeep backup system.
This is shared in between the client/server components.

%package client
Summary:        The SafeKeep backup system (client component)
Group:          Applications/System
Requires:       openssh-server
Requires:       coreutils
Requires:       util-linux
Requires(pre):  safekeep-common = %{PACKAGE_VERSION}

%description client
The client component of the SafeKeep backup system.
This component should be installed on all hosts that
need to be backed-up.

%package server
Summary:        The SafeKeep backup system (server component)
Group:          Applications/System
Prereq:         /usr/sbin/useradd
Requires:       openssh, openssh-clients
Requires(pre):  safekeep-common = %{PACKAGE_VERSION}

%description server
The server component of the SafeKeep backup system.
This compoenent should be installed on the server on
which the data will be backed-up to.

%prep
%setup -q

%build
make build

%install
install -d -m 755 "%{buildroot}%{_sysconfdir}/safekeep.d"
install -d -m 755 "%{buildroot}%{_sysconfdir}/cron.daily"
install -m 755 safekeep.cron "%{buildroot}%{_sysconfdir}/cron.daily"
install -d -m 755 "%{buildroot}%{_bindir}/"
install -m 755 safekeep "%{buildroot}%{_bindir}/"
install -d -m 755 "%{buildroot}%{_mandir}/man1/"
install -m 755 doc/safekeep.1 "%{buildroot}%{_mandir}/man1/"
install -d -m 755 "%{buildroot}%{_mandir}/man5/"
install -m 755 doc/safekeep.conf.5 "%{buildroot}%{_mandir}/man5/"
install -d -m 750 "%{buildroot}%{homedir}"
install -d -m 700 "%{buildroot}%{homedir}/.ssh"

%clean
rm -rf "%{buildroot}"

%pre server
%{_sbindir}/useradd -r -d %{homedir} -s /sbin/nologin -u 186 %{name} 2> /dev/null || :

%preun server
if [ "$1" = "0" ]; then
    %{_sbindir}/userdel %{name} >> /dev/null 2>&1 || :
fi

%files common
%defattr(-,root,root,-)
%{_bindir}/safekeep
%{_mandir}/man1/safekeep.1*
%{_mandir}/man5/safekeep.5*
%doc AUTHORS COPYING LICENSE README TODO

%files client
%doc AUTHORS COPYING LICENSE

%files server
%attr(750,%{name},%{name}) %dir %{homedir}
%attr(700,%{name},%{name}) %dir %{homedir}/.ssh
%dir %{_sysconfdir}/safekeep.d
%config %{_sysconfdir}/cron.daily/safekeep.cron
%doc safekeep-test sample.conf
%doc AUTHORS COPYING LICENSE

%changelog

